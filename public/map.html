<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IT Parking Map</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x/dist/cdn.min.js" defer></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;}
    svg .slot{cursor:pointer; transition:fill .15s,stroke .15s;}
    svg .slot.available{fill:#d1fae5;}
    svg .slot.occupied{fill:#fecaca;}
    svg .slot.reserved{fill:#fef3c7;}
    svg{width:100%;height:auto;display:block;}
    .panel{max-width:900px;margin:20px auto;padding:12px;border:1px solid #ddd;border-radius:6px;}
  </style>
</head>
<body>
  <div class="panel" x-data="parkingMap()" x-init="init()">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>IT Parking — Interactive Map</h1>
      <div><button @click="refresh()">Refresh</button> <span x-text="statusText"></span></div>
    </div>

    <div style="background:#fff;padding:12px;margin-top:12px;">
      <!-- Simple inline SVG demo: replace with real SVG later.
           IMPORTANT: each slot shape must have id="slot-<N>" matching DB svg_id -->
      <svg viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg">
        <rect id="slot-1" class="slot" x="40" y="30" width="140" height="70" rx="8"/>
        <rect id="slot-2" class="slot" x="200" y="30" width="140" height="70" rx="8"/>
        <rect id="slot-3" class="slot" x="360" y="30" width="140" height="70" rx="8"/>
        <rect id="slot-4" class="slot" x="40" y="120" width="140" height="70" rx="8"/>
        <rect id="slot-5" class="slot" x="200" y="120" width="140" height="70" rx="8"/>
      </svg>
    </div>

    <div style="margin-top:12px;padding:12px;background:#fff;border:1px solid #ddd;border-radius:6px;">
      <template x-if="selected">
        <div>
          <h3>Selected: <span x-text="selected"></span></h3>
          <p x-text="slotInfoText"></p>
          <div style="margin-top:8px;">
            <button x-show="slotStatus==='available'" @click="reserve(selected)">Reserve</button>
            <button @click="checkin(selected)">Check-in</button>
            <button @click="forceRelease(selected)">Force Release</button>
          </div>
        </div>
      </template>
      <template x-if="!selected">
        <div>Click a slot to select it.</div>
      </template>
    </div>
  </div>

  <script>
  function parkingMap(){
    return {
      slots: {},
      selected: null,
      slotStatus: null,
      statusText: 'idle',
      slotInfoText: '',
      init() {
        this.refresh();
        document.querySelectorAll('.slot').forEach(el=>{
          el.addEventListener('click', ev=>{
            ev.stopPropagation();
            this.onClickSlot(el.id);
          });
        });
        document.addEventListener('click', ()=> this.selected = null);
      },
      async refresh(){
        this.statusText = 'loading';
        try {
          const res = await fetch('api.php?action=get_slot_status');
          const data = await res.json();
          this.slots = data.slots || {};
          this.applyStyles();
          this.statusText = 'updated ' + new Date().toLocaleTimeString();
        } catch(e) {
          this.statusText = 'error';
        }
      },
      applyStyles(){
        document.querySelectorAll('.slot').forEach(el=>{
          const info = this.slots[el.id] || null;
          el.classList.remove('available','occupied','reserved');
          if (!info) return;
          if (info.status === 'available') el.classList.add('available');
          else if (info.status === 'checked_in' || info.status === 'occupied') el.classList.add('occupied');
          else el.classList.add('reserved');
        });
      },
      onClickSlot(svgId){
        this.selected = svgId;
        const info = this.slots[svgId] || {status:'available'};
        this.slotStatus = info.status;
        this.slotInfoText = 'Status: ' + info.status + (info.vehicle_number ? ' — ' + info.vehicle_number : '');
      },
      async reserve(svgId){
        const vehicle = prompt('Vehicle number (e.g. KA01AB1234):','KA-00-TEST');
        if (!vehicle) return;
        const res = await fetch('api.php?action=reserve_slot', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ svg_id: svgId, vehicle_number: vehicle })
        });
        const d = await res.json();
        alert(d.success ? 'Reserved (id '+d.reservation_id+')' : 'Failed: '+d.message);
        await this.refresh();
      },
      async checkin(svgId){
        const vehicle = prompt('Vehicle number for check-in:','KA-00-TEST');
        if (!vehicle) return;
        const res = await fetch('api.php?action=checkin_slot', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ svg_id: svgId, vehicle_number: vehicle })
        });
        const d = await res.json();
        alert(d.success ? 'Checked in (id '+d.reservation_id+')' : 'Failed: '+d.message);
        await this.refresh();
      },
      async forceRelease(svgId){
        if (!confirm('Force release this slot?')) return;
        const res = await fetch('api.php?action=release_slot', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ svg_id: svgId })
        });
        const d = await res.json();
        alert(d.success ? 'Released' : 'Failed');
        await this.refresh();
      }
    };
  }
  </script>
</body>
</html>
